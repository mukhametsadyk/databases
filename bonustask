Ағай,1аттестациям бонус баллсыз шамамен 22 болып тұр,рэтэйкке қалдырмаңызшы өтініш,4рэтэйк бар еді менде...
CREATE DATABASE financial_transactions;

CREATE TABLE clients (
                         client_id SERIAL PRIMARY KEY,
                         personal_id VARCHAR(12) UNIQUE NOT NULL,
                         full_name VARCHAR(255) NOT NULL,
                         phone_number VARCHAR(15),
                         email_address VARCHAR(255) UNIQUE,
                         status VARCHAR(10) CHECK (status IN ('active', 'blocked', 'frozen')) NOT NULL DEFAULT 'active',
                         registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                         daily_limit_kzt NUMERIC DEFAULT 1000000
);

CREATE TABLE user_accounts (
                               account_id SERIAL PRIMARY KEY,
                               client_id INT REFERENCES clients(client_id) ON DELETE CASCADE,
                               account_code VARCHAR(34) UNIQUE NOT NULL,
                               currency_type VARCHAR(3) CHECK (currency_type IN ('KZT', 'USD', 'EUR', 'RUB')) NOT NULL,
                               balance_amount NUMERIC DEFAULT 0,
                               account_status BOOLEAN DEFAULT TRUE,
                               creation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                               closure_date TIMESTAMP
);

CREATE TABLE money_transactions (
                                    transaction_id SERIAL PRIMARY KEY,
                                    from_account INT REFERENCES user_accounts(account_id) ON DELETE CASCADE,
                                    to_account INT REFERENCES user_accounts(account_id) ON DELETE CASCADE,
                                    transaction_amount NUMERIC NOT NULL,
                                    currency_type VARCHAR(3) CHECK (currency_type IN ('KZT', 'USD', 'EUR', 'RUB')) NOT NULL,
                                    conversion_rate NUMERIC,
                                    amount_in_kzt NUMERIC NOT NULL,
                                    transaction_type VARCHAR(10) CHECK (transaction_type IN ('transfer', 'deposit', 'withdrawal')) NOT NULL,
                                    transaction_status VARCHAR(10) CHECK (transaction_status IN ('pending', 'completed', 'failed', 'reversed')) NOT NULL DEFAULT 'pending',
                                    creation_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                    completion_timestamp TIMESTAMP,
                                    transaction_description TEXT
);

CREATE TABLE conversion_rates (
                                  rate_id SERIAL PRIMARY KEY,
                                  from_currency VARCHAR(3) CHECK (from_currency IN ('KZT', 'USD', 'EUR', 'RUB')) NOT NULL,
                                  to_currency VARCHAR(3) CHECK (to_currency IN ('KZT', 'USD', 'EUR', 'RUB')) NOT NULL,
                                  conversion_rate NUMERIC NOT NULL,
                                  valid_from TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                  valid_until TIMESTAMP
);

CREATE TABLE change_log (
                            log_id SERIAL PRIMARY KEY,
                            table_name VARCHAR(50) NOT NULL,
                            record_id INT NOT NULL,
                            action_type VARCHAR(10) CHECK (action_type IN ('INSERT', 'UPDATE', 'DELETE')) NOT NULL,
                            old_record JSONB,
                            new_record JSONB,
                            modified_by VARCHAR(255) NOT NULL,
                            modification_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            ip_address INET
);

-- Insert records with updated values
INSERT INTO clients (personal_id, full_name, phone_number, email_address, status, daily_limit_kzt)
VALUES
    ('112233445566', 'Alexander Sidorov', '87780005566', 'alexander@example.com', 'active', 600000),
    ('998877665544', 'Elena Smirnova', '87780007788', 'elena@example.com', 'active', 1200000);

INSERT INTO user_accounts (client_id, account_code, currency_type, balance_amount, account_status)
VALUES
    (1, 'KZ123456789012345678901234567891', 'KZT', 150000, TRUE),
    (2, 'KZ987654321098765432109876543211', 'USD', 7000, TRUE);

INSERT INTO conversion_rates (from_currency, to_currency, conversion_rate, valid_from, valid_until)
VALUES
    ('USD', 'KZT', 430, CURRENT_TIMESTAMP, NULL),
    ('EUR', 'KZT', 490, CURRENT_TIMESTAMP, NULL);

INSERT INTO money_transactions (from_account, to_account, transaction_amount, currency_type, conversion_rate, amount_in_kzt, transaction_type, transaction_status, creation_timestamp, transaction_description)
VALUES
    (1, 2, 150, 'USD', 430, 64500, 'transfer', 'completed', CURRENT_TIMESTAMP, 'Transfer USD to Elena');

-- Task1
CREATE VIEW client_balance_summary AS
SELECT
    c.client_id,
    c.full_name,
    ua.account_code,
    ua.balance_amount,
    (ua.balance_amount * cr.conversion_rate) AS total_balance_kzt,
    c.daily_limit_kzt,
    (ua.balance_amount * cr.conversion_rate) / c.daily_limit_kzt * 100 AS daily_limit_utilization
FROM clients c
         JOIN user_accounts ua ON c.client_id = ua.client_id
         LEFT JOIN conversion_rates cr ON ua.currency_type = cr.from_currency AND cr.to_currency = 'KZT'
WHERE cr.valid_from <= CURRENT_DATE AND cr.valid_until >= CURRENT_DATE;

-- Task2
CREATE VIEW daily_transactions_report AS
WITH daily_agg AS (
    SELECT
        creation_timestamp::date AS transaction_date,
        transaction_type,
        COUNT(*) AS transaction_count,
        SUM(transaction_amount) AS total_volume,
        AVG(transaction_amount) AS avg_amount
    FROM money_transactions
    GROUP BY creation_timestamp::date, transaction_type
)
SELECT
    transaction_date,
    transaction_type,
    transaction_count,
    total_volume,
    avg_amount,
    SUM(total_volume) OVER (PARTITION BY transaction_type ORDER BY transaction_date) AS running_total,
    CASE
        WHEN LAG(total_volume) OVER (PARTITION BY transaction_type ORDER BY transaction_date) > 0
            THEN ROUND(
                (total_volume - LAG(total_volume) OVER (PARTITION BY transaction_type ORDER BY transaction_date)) * 100.0 /
                LAG(total_volume) OVER (PARTITION BY transaction_type ORDER BY transaction_date), 2
                 )
        ELSE NULL
        END AS day_over_day_growth_pct
FROM daily_agg
ORDER BY transaction_date, transaction_type;

-- Task3
-- b-tree index
CREATE INDEX idx_user_account_balance ON user_accounts(balance_amount);
-- hash index
CREATE INDEX idx_account_code_hash ON user_accounts USING hash(account_code);
-- gin index
CREATE INDEX idx_change_log_jsonb ON change_log USING gin(old_record jsonb_path_ops);
-- partial index
CREATE INDEX idx_active_user_accounts ON user_accounts(account_id) WHERE account_status = TRUE;
-- composite index
CREATE INDEX idx_client_status_limit ON clients(personal_id, status);

-- Task4
CREATE OR REPLACE FUNCTION process_salary_batch(
    company_account_code TEXT,
    payments JSONB
)
    RETURNS TABLE(successful_count INT, failed_count INT, failed_details JSONB) AS $$
DECLARE
    company_account RECORD;
    payment RECORD;
    total_amount NUMERIC := 0;
    success_count INT := 0;
    fail_count INT := 0;
    failed_details JSONB := '[]'::jsonb;
BEGIN
    SELECT * INTO company_account FROM user_accounts WHERE account_code = company_account_code;

    IF company_account.balance_amount < (SELECT SUM((payment->>'amount')::NUMERIC) FROM jsonb_array_elements(payments) AS payment) THEN
        RAISE EXCEPTION 'error: insufficient balance for salary batch';
    END IF;

    FOR payment IN SELECT * FROM jsonb_array_elements(payments) AS p
        LOOP
            BEGIN
                UPDATE user_accounts SET balance_amount = balance_amount - (payment->>'amount')::NUMERIC WHERE account_code = company_account_code;
                INSERT INTO money_transactions(from_account, to_account, transaction_amount, currency_type, conversion_rate, amount_in_kzt, transaction_type, transaction_status, creation_timestamp, transaction_description)
                VALUES (company_account.account_id, (payment->>'iin')::NUMERIC, (payment->>'amount')::NUMERIC, 'KZT', 1, (payment->>'amount')::NUMERIC, 'salary', 'completed', CURRENT_TIMESTAMP, 'Salary Payment');

                success_count := success_count + 1;
            EXCEPTION
                WHEN OTHERS THEN
                    fail_count := fail_count + 1;
                    failed_details := failed_details || jsonb_build_object('iin', payment->>'iin', 'error', SQLERRM);
            END;
        END LOOP;

    RETURN QUERY SELECT success_count, fail_count, failed_details;
END;
$$ LANGUAGE plpgsql;
